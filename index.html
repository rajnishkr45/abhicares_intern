<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AbhiCares Support</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f0f2f5;
            --card: #ffffff;
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --user-bubble: #e0e7ff;
            --bot-bubble: #f3f4f6;
            --text-main: #111827;
            --text-muted: #6b7280;
        }

        * {
            box-sizing: border-box;
        }

        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #3b3b3b;
            width: 5px;
        }

        body {
            margin: 0;
            background: var(--bg);
            font-family: 'Inter', system-ui, sans-serif;
            color: var(--text-main);
            height: 100vh;
            display: flex;
            justify-content: center;
            overflow: hidden;
            /* Prevents full page scroll */
        }

        .app-container {
            width: 100%;
            max-width: 900px;
            /* Limits width on big screens */
            height: 100%;
            background: var(--card);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        /* Header */
        .chat-header {
            flex-shrink: 0;
            /* Prevents shrinking */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            z-index: 10;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(99, 102, 241, 0.3);
        }

        .title {
            font-weight: 700;
            font-size: 16px;
        }

        .status {
            font-size: 12px;
            color: #10b981;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status::before {
            content: '';
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            display: block;
        }

        #clearBtn {
            background: transparent;
            border: 1px solid #e5e7eb;
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        #clearBtn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            color: #374151;
        }

        /* Messages Area - SCROLLS HERE */
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            /* Scroll strictly inside here */
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
            background-color: #ffffff;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .message-row {
            display: flex;
            width: 100%;
        }

        .row-left {
            justify-content: flex-start;
        }

        .row-right {
            justify-content: flex-end;
        }

        .bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .bubble.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .bubble.assistant {
            background: var(--bot-bubble);
            color: var(--text-main);
            border-bottom-left-radius: 4px;
        }

        .bubble.user {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        .bubble-meta {
            font-size: 10px;
            margin-top: 6px;
            opacity: 0.7;
            text-align: right;
        }

        /* Composer - FIXED BOTTOM */
        .composer {
            flex-shrink: 0;
            padding: 16px 20px;
            border-top: 1px solid #e5e7eb;
            background: white;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .composer textarea {
            flex: 1;
            padding: 12px 14px;
            border-radius: 24px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            resize: none;
            height: 48px;
            /* Initial height */
            max-height: 120px;
            font-family: inherit;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .composer textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background: white;
        }

        #send {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s, background 0.2s;
        }

        #send:hover {
            background: var(--primary-dark);
        }

        #send:active {
            transform: scale(0.95);
        }

        #send svg {
            width: 20px;
            height: 20px;
            fill: white;
            margin-left: 2px;
        }

        /* Mobile tweaks */
        @media (max-width: 600px) {
            .app-container {
                max-width: 100%;
                border-radius: 0;
            }

            .bubble {
                max-width: 85%;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="chat-header">
            <div class="header-left">
                <div class="avatar">ü§ñ</div>
                <div>
                    <div class="title">AbhiCares Support</div>
                    <div class="status">Online</div>
                </div>
            </div>
            <div class="header-actions">
                <button id="clearBtn">Clear</button>
            </div>
        </header>

        <section id="messages" class="messages"></section>

        <form id="composer" class="composer" autocomplete="off">
            <textarea id="input" placeholder="Type a message..." rows="1"></textarea>
            <button type="button" id="send">
                <svg viewBox="0 0 24 24">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                </svg>
            </button>
        </form>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let chatState = {
            step: 0, // 0=Name, 1=Lang, 2=FuzzyLogic
            userName: '',
            userLang: ''
        };

        // --- BRAIN: KNOWLEDGE BASE ---
        const knowledgeBase = [
            // GREETINGS & BASICS
            { k: ['hello', 'hi', 'hey', 'start'], r: "Hello again! How can AbhiCares help you today?" },
            { k: ['who', 'are', 'you'], r: "I am the AbhiCares Virtual Assistant. I help with scheduling, pricing, and basic troubleshooting." },
            { k: ['contact', 'phone', 'call'], r: "Call our support team at (555) 123-4567. Open 24/7." },
            { k: ['location', 'address'], r: "We are located at 123 Service Lane, Downtown." },

            // PRICING
            { k: ['price', 'cost', 'fee', 'charge'], r: "Our standard service visit fee is $49. Final repairs are quoted on-site." },
            { k: ['payment', 'card', 'cash'], r: "We accept Cash, Credit Cards, and Online Payments." },

            // HVAC (AC/Heating)
            { k: ['ac', 'cooling', 'hot', 'warm'], r: "If the AC is blowing warm air, check your thermostat settings. It might be a refrigerant leak." },
            { k: ['leak', 'water', 'drip'], r: "Water dripping from the AC is usually a clogged drain line. Turn it off to prevent damage." },
            { k: ['heater', 'furnace', 'cold'], r: "For heating issues, check if your pilot light is on (gas) or check the breaker (electric)." },
            { k: ['filter', 'dust', 'dirty'], r: "Replace air filters every 1-3 months to keep the system efficient." },

            // PLUMBING
            { k: ['toilet', 'clog', 'flush'], r: "Try plunging the toilet. If water overflows, turn off the valve behind the toilet." },
            { k: ['sink', 'drain', 'slow'], r: "Slow drains can often be fixed with a snake tool. Avoid harsh chemicals if possible." },
            { k: ['leak', 'pipe', 'burst'], r: "‚ö†Ô∏è Turn off your main water supply immediately to stop flooding. Then call us." },
            { k: ['water', 'heater', 'shower'], r: "No hot water? Check the water heater pilot light or breaker." },

            // ELECTRICAL
            { k: ['light', 'flicker', 'blink'], r: "Flickering lights might mean a loose bulb or a wiring issue. If it's the whole house, call us immediately." },
            { k: ['breaker', 'trip', 'power'], r: "Reset the breaker once. If it trips again, do not force it. You may have a short circuit." },
            { k: ['outlet', 'plug', 'dead'], r: "Check for a GFCI 'Reset' button on the outlet. These trip to protect you from shock." },

            // SCHEDULING
            { k: ['book', 'appointment', 'schedule'], r: "I can help book that. Please leave your phone number and preferred time." },
            { k: ['cancel', 'change'], r: "To cancel, please provide your Order ID or call dispatch." }
        ];

        const defaultResponse = "I'm not sure about that. Could you describe the issue differently? (e.g., 'AC leak', 'Clogged sink')";

        // --- FUZZY LOGIC ---
        function findBestMatch(userText) {
            const tokens = userText.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
            let bestMatch = null;
            let maxScore = 0;

            knowledgeBase.forEach(entry => {
                let score = 0;
                entry.k.forEach(keyword => {
                    const kStem = keyword.toLowerCase();
                    tokens.forEach(t => {
                        if (t === kStem) score += 3; // Exact match
                        else if (t.includes(kStem) || kStem.includes(t)) score += 1; // Partial
                    });
                });
                if (score > maxScore) {
                    maxScore = score;
                    bestMatch = entry;
                }
            });

            return (maxScore > 0) ? bestMatch.r : defaultResponse;
        }

        // --- DOM ELEMENTS ---
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        const clearBtn = document.getElementById('clearBtn');

        // --- CORE FUNCTIONS ---

        function formatTime() {
            return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function scrollToBottom() {
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function addBubble(role, htmlContent, isTyping = false) {
            const row = document.createElement('div');
            row.className = `message-row ${role === 'user' ? 'row-right' : 'row-left'}`;

            const bubble = document.createElement('div');
            bubble.className = `bubble ${role} ${isTyping ? 'typing' : ''}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'bubble-text';
            contentDiv.innerHTML = htmlContent;

            const metaDiv = document.createElement('div');
            metaDiv.className = 'bubble-meta';
            metaDiv.innerText = isTyping ? '' : formatTime();

            bubble.appendChild(contentDiv);
            bubble.appendChild(metaDiv);
            row.appendChild(bubble);
            messagesEl.appendChild(row);

            scrollToBottom();

            // Animate entrance
            requestAnimationFrame(() => bubble.classList.add('visible'));

            return bubble;
        }

        function typeText(bubble, text) {
            const container = bubble.querySelector('.bubble-text');
            container.innerHTML = '';
            let i = 0;

            function step() {
                if (i < text.length) {
                    container.innerHTML += text.charAt(i);
                    i++;
                    scrollToBottom();
                    setTimeout(step, 15);
                } else {
                    // update time when done
                    bubble.querySelector('.bubble-meta').innerText = formatTime();
                }
            }
            step();
        }

        function processUserMessage() {
            const text = inputEl.value.trim();
            if (!text) return;

            // 1. Add User Bubble
            addBubble('user', text);
            inputEl.value = '';
            inputEl.style.height = '48px'; // Reset height

            // 2. Add Bot "Typing" Bubble
            const botBubble = addBubble('assistant', '‚Ä¢‚Ä¢‚Ä¢', true);

            // 3. Logic & Delay
            setTimeout(() => {
                let reply = "";

                // --- STATE MACHINE LOGIC ---
                if (chatState.step === 0) {
                    // User just gave Name
                    chatState.userName = text;
                    chatState.step = 1;
                    reply = `Nice to meet you, <b>${chatState.userName}</b>! üëã<br>Which language do you prefer? (English or Hindi)`;
                }
                else if (chatState.step === 1) {
                    // User just gave Language
                    chatState.userLang = text;
                    chatState.step = 2;
                    reply = `Great! I've noted <b>${chatState.userLang}</b>.<br><br>Now, tell me, what service issue are you facing today?<br><i>(e.g., 'My AC is leaking', 'Need a plumber')</i>`;
                }
                else {
                    // Normal Chat Mode
                    reply = findBestMatch(text);
                }

                // Remove typing dots and type text
                typeText(botBubble, reply);

            }, 800);
        }

        // --- EVENT LISTENERS ---
        sendBtn.addEventListener('click', processUserMessage);

        inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                processUserMessage();
            }
        });

        // Auto-grow textarea
        inputEl.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        clearBtn.addEventListener('click', () => {
            messagesEl.innerHTML = '';
            chatState.step = 0; // Reset State
            startConversation();
        });

        // --- INITIALIZATION ---
        function startConversation() {
            setTimeout(() => {
                const b = addBubble('assistant', '‚Ä¢‚Ä¢‚Ä¢', true);
                typeText(b, "Welcome to AbhiCares! üõ†Ô∏è<br>I am your automated assistant.<br><br>First, may I know your <b>Name</b>?");
            }, 600);
        }

        window.onload = startConversation;

    </script>
</body>

</html>