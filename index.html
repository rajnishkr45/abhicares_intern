<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abhicares Support</title>
    <link rel="stylesheet" href="styless.css">
</head>

<body>

    <div class="chat-container">
        <div class="chat-header">
            <img src="./logo.png" class="profile-pic" alt="">
            <div class="header-info">
                <h4>Abhicares Support</h4>
                <p>‚óè Online</p>
            </div>
        </div>

        <div class="chat-body" id="chatBody"></div>

        <div class="chat-footer" id="inputArea">
            <input type="text" id="userInput" placeholder="Type a message..." autocomplete="off"
                onkeypress="handleEnter(event)">
            <button class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>
    <script>
/* ================================ GLOBAL STATE ================================ */

        let step = 0;        // 0 = init, 1 = name, 2 = language, 3 = chat
        let userName = "";
        let userLang = "";

        const chatBody = document.getElementById("chatBody");
        const userInput = document.getElementById("userInput");
        const inputArea = document.getElementById("inputArea");

/* ================================ INIT ================================ */

        window.onload = () => {
            const typingId = showTypingAnim();

            // 2Ô∏è‚É£ After 2 seconds, remove typing & show message
            setTimeout(() => {
                removeTyping(typingId);

                addBotMessage(
                    `Hello üëã Welcome to <strong>Abhicares</strong>.<br>
                 I'm your virtual assistant.<br>
                 <strong>May I know your name?</strong>`
                );

                step = 1;
            }, 2000);
        };


/* ================================ ENTER KEY ================================ */

        function handleEnter(e) {
            if (e.key === "Enter") sendMessage();
        }

/* ================================ SEND MESSAGE ================================ */

        function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            addUserMessage(text);
            userInput.value = "";

            /* STEP 1 ‚Üí NAME */
            if (step === 1) {
                userName = text;
                const typingId = showTypingAnim();
                setTimeout(() => {
                    removeTyping(typingId);
                    addBotMessage(
                        `Nice to meet you, <strong>${userName}</strong> üòä<br>
                         Please select your preferred language:`
                    );
                    showLanguageOptions();
                    step = 2;
                }, 2000);
                return;
            }

            /* STEP 3 ‚Üí CHAT */
            if (step === 3) {
                processAbhicaresLogic(text);
            }
        }

/* ================================ LANGUAGE OPTIONS ================================ */

        function showLanguageOptions() {
            const container = document.createElement("div");
            container.className = "options-container";

            ["English", "Hindi", "Hinglish"].forEach(lang => {
                const btn = document.createElement("button");
                btn.className = "option-btn";
                btn.innerText = lang;
                btn.onclick = () => selectLanguage(lang);
                container.appendChild(btn);
            });

            chatBody.appendChild(container);
            scrollToBottom();
        }

        function selectLanguage(lang) {
            userLang = lang;

            const opts = document.querySelector(".options-container");
            if (opts) opts.remove();

            addUserMessage(lang);

            const typingId = showTypingAnim();
            setTimeout(() => {
                removeTyping(typingId);
                addBotMessage(
                    `Great üëç I will continue in <strong>${userLang}</strong>.<br>
                     How can I help you today?`
                );
                step = 3;
            }, 1000);
        }

/* ================================ MAIN CHAT LOGIC ================================ */

        async function processAbhicaresLogic(text) {
            const msg = text.toLowerCase();

            // Quick human help
            if (
                msg.includes("call") ||
                msg.includes("book") ||
                msg.includes("booking") ||
                msg.includes("technician") ||
                msg.includes("service") ||
                msg.includes("‡§∏‡•á‡§µ‡§æ")
            ) {
                setTimeout(() => {
                    addBotMessage(
                        `For bookings or urgent help, please call:<br>
                         <strong>üìû +91 98765 43210</strong>`
                    );
                }, 800);
                return;
            }

            // Exit
            if (msg.includes("bye") || msg.includes("thank")) {
                setTimeout(() => {
                    addBotMessage("Thank you for choosing Abhicares üåü");
                    inputArea.style.pointerEvents = "none";
                    inputArea.style.opacity = "0.6";
                }, 800);
                return;
            }

            const typingId = showTypingAnim();

            try {
                const res = await fetch("chat.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: text,
                        user_name: userName,
                        user_lang: userLang
                    })
                });

                const data = await res.json();
                removeTyping(typingId);

                addBotMessage(data.reply || "Sorry, I couldn‚Äôt respond.");

            } catch (err) {
                removeTyping(typingId);
                addBotMessage("‚ö†Ô∏è Server connection error.");
            }
        }

/* ================================ UI HELPERS ================================ */

        function addUserMessage(text) {
            const div = document.createElement("div");
            div.className = "message user-msg";
            div.innerHTML = text;
            chatBody.appendChild(div);
            scrollToBottom();
        }

        function addBotMessage(html) {
            const div = document.createElement("div");
            div.className = "message bot-msg";
            div.innerHTML = html;
            chatBody.appendChild(div);
            scrollToBottom();
        }

/* ================================ TYPING ANIMATION ================================ */

        function showTypingAnim() {
            const id = "typing-" + Date.now();

            const div = document.createElement("div");
            div.id = id;
            div.className = "message bot-msg";
            div.innerHTML = `
                <div class="typing-indicator">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            `;

            chatBody.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    </script>

</body>

</html>